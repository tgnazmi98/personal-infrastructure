services:
  timescaledb:
    image: timescale/timescaledb:latest-pg17
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - timescale_data:/var/lib/postgresql/data
    ports:
      - "${HOMELAB_IP}:5432:5432"
    networks:
      - opengrid
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 30s
      timeout: 10s
      retries: 5

  backend:
    build: ./repos/backend/backend
    environment:
      - DEBUG=${DEBUG}
      - SECRET_KEY=${SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - JWT_ACCESS_TOKEN_LIFETIME=${JWT_ACCESS_TOKEN_LIFETIME}
      - JWT_REFRESH_TOKEN_LIFETIME=${JWT_REFRESH_TOKEN_LIFETIME}
    depends_on:
      timescaledb:
        condition: service_healthy
    networks:
      - opengrid
    command: >
      sh -c "python manage.py makemigrations &&
             python manage.py migrate &&
             python manage.py setup_timescaledb &&
             python manage.py collectstatic --noinput &&
             daphne -b 0.0.0.0 -p 8000 electrical_monitoring.asgi:application"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "traefik.enable=true"
      # Main API router
      - "traefik.http.routers.backend.rule=Host(`${BACKEND_DOMAIN}`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.routers.backend.priority=10"
      - "traefik.http.routers.backend.middlewares=proxy-headers@file"
      - "traefik.http.routers.backend.service=backend"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"
      - "traefik.http.services.backend.loadbalancer.serversTransport=default-timeout@file"
      # WebSocket router (higher priority for /ws/)
      - "traefik.http.routers.backend-ws.rule=Host(`${BACKEND_DOMAIN}`) && PathPrefix(`/ws/`)"
      - "traefik.http.routers.backend-ws.entrypoints=web"
      - "traefik.http.routers.backend-ws.priority=20"
      - "traefik.http.routers.backend-ws.middlewares=proxy-headers@file"
      - "traefik.http.routers.backend-ws.service=backend-ws"
      - "traefik.http.services.backend-ws.loadbalancer.server.port=8000"
      - "traefik.http.services.backend-ws.loadbalancer.serversTransport=websocket-long@file"

  frontend:
    build:
      context: ./repos/frontend
      args:
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
        - NEXT_PUBLIC_WS_HOST=${NEXT_PUBLIC_WS_HOST}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - opengrid
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${FRONTEND_DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.routers.frontend.middlewares=proxy-headers@file"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

  logger:
    build: ./repos/backend/logger
    environment:
      - API_BASE_URL=${API_BASE_URL}
      - DEVICE_IP=${DEVICE_IP}
      - DEVICE_PORT=${DEVICE_PORT}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - opengrid
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  traefik:
    image: traefik:3.6.7
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command:
      - "--configFile=/etc/traefik/traefik.yml"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      opengrid:
        aliases:
          - nginx-proxy
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-health.rule=Path(`/health`)"
      - "traefik.http.routers.traefik-health.entrypoints=web"
      - "traefik.http.routers.traefik-health.service=ping@internal"
      - "traefik.http.routers.traefik-health.priority=100"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate --protocol http2 --edge-ip-version auto run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      traefik:
        condition: service_healthy
    networks:
      - opengrid
    restart: unless-stopped

networks:
  opengrid:
    name: opengrid
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: 172.19.0.0/16
        - subnet: fd00:dead:beef::/48

volumes:
  timescale_data:
